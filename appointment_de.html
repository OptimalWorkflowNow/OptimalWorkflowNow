<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminbuchung - Deutsch</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* Your existing CSS styles (same for both languages) */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 450px;
        }
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        p {
            text-align: center;
            color: #666;
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 18px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-weight: bold;
        }
        input[type="text"],
        input[type="email"],
        input[type="tel"] {
            width: calc(100% - 22px);
            padding: 11px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 15px;
        }
        input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 4phx;
            cursor: pointer;
            font-size: 17px;
            font-weight: bold;
            margin-top: 20px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #message {
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            padding: 10px;
            border-radius: 4px;
            display: none; /* Standardmäßig ausgeblendet */
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message.info {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        .language-switcher {
            text-align: center;
            margin-bottom: 20px;
        }
        .language-switcher a {
            margin: 0 5px;
            text-decoration: none;
            color: #007BFF;
            font-weight: bold;
        }
        .language-switcher a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div class="language-switcher">
    <a href="appointment_en.html">English</a> | <a href="appointment_de.html">Deutsch</a>
</div>

<div class="container">
    <h2>Termin buchen</h2>
    <p>Wählen Sie einen passenden Termin für eine Beratung und geben Sie Ihre Daten ein.</p>

    <form id="appointmentForm">
        <div class="form-group">
            <label for="name">Ihr Name:</label>
            <input type="text" id="name" name="name" required>
        </div>
        <div class="form-group">
            <label for="email">Ihre E-Mail:</label>
            <input type="email" id="email" name="email" required>
        </div>
        <div class="form-group">
            <label for="phone">Ihre Telefonnummer:</label>
            <input type="tel" id="phone" name="phone" placeholder="+49 (XXX) XXX-XX-XX" required>
        </div>
        <div class="form-group">
            <label for="datetime">Datum und Uhrzeit wählen:</label>
            <input type="text" id="datetime" name="datetime" required>
        </div>
        <div class="form-group checkbox-group">
            <input type="checkbox" id="telegramNotifications" name="telegramNotifications">
            <label for="telegramNotifications">Telegram-Benachrichtigungen erhalten</label>
        </div>
        <button type="submit">Jetzt buchen</button>
    </form>
    <div id="message"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/de.js"></script>

<script>
  // !!! IMPORTANT: Replace these URLs with your actual n8n Webhook URLs !!!
  const N8N_WEBHOOK_URL_AVAILABLE_SLOTS = 'http://localhost:5678/webhook/get-available-slots';
  const N8N_WEBHOOK_URL_BOOK_APPOINTMENT = 'ВАШ_N8N_WEBHOOK_URL_ДЛЯ_ЗАПИСИ';

  let flatpickrInstance;

  function showMessage(msg, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = msg;
    messageDiv.className = 'message ' + type;
    messageDiv.style.display = 'block';
  }

  async function loadAvailableSlots() {
    console.log("loadAvailableSlots function started.");
    showMessage("Loading available slots...", "info");

    const datetimeInput = document.getElementById('datetime');
    const submitButton = document.querySelector('#appointmentForm button[type="submit"]');

    try {
      const response = await axios.get(N8N_WEBHOOK_URL_AVAILABLE_SLOTS);
      const data = response.data;

      let availableSlotsStrings = (data && Array.isArray(data.availableSlots)) ? data.availableSlots : [];

      console.log("Raw fetched available slots (from n8n):", availableSlotsStrings);

      // --- Parsing ISO strings to Date objects for Flatpickr's 'enable' option ---
      const parsedAvailableDates = availableSlotsStrings.map(slotStr => {
        // Parse the ISO string. If it's YYYY-MM-DDTHH:mm:ss (no Z or offset),
        // JavaScript's new Date() will interpret it as local time. This is generally desired for Flatpickr.
        const tempDate = new Date(slotStr);

        if (isNaN(tempDate.getTime())) {
          console.warn(`Flatpickr: Failed to parse date string from n8n: "${slotStr}". This slot will be ignored.`);
          return null;
        }

        // Create a NEW Date object, explicitly setting seconds and milliseconds to 0.
        // This ensures perfect alignment with Flatpickr's minuteIncrement.
        // We use the local time components (hours, minutes, etc.) from the parsed tempDate.
        const cleanDate = new Date(
          tempDate.getFullYear(),
          tempDate.getMonth(),
          tempDate.getDate(),
          tempDate.getHours(),
          tempDate.getMinutes(),
          0,  // Set seconds to 0
          0   // Set milliseconds to 0
        );
        return cleanDate;
      }).filter(date => date !== null); // Filter out any invalid dates

      console.log("Parsed and Cleaned available slots (for Flatpickr's 'enable'):", parsedAvailableDates);

      // *** NEW DEBUGGING LOGS FOR EACH PARSED DATE TO VERIFY PRECISION ***
      if (parsedAvailableDates.length > 0) {
        console.group("Detailed view of Parsed and Cleaned Slots:");
        parsedAvailableDates.forEach((d, index) => {
          console.log(`Slot ${index}: ${d.toLocaleString()} | Seconds: ${d.getSeconds()} | Milliseconds: ${d.getMilliseconds()} | ISO: ${d.toISOString()}`);
        });
        console.groupEnd();
      } else {
        console.log("No available slots after parsing and cleaning.");
      }
      // *** END NEW DEBUGGING LOGS ***


      // Destroy existing Flatpickr instance if it exists before re-initializing
      if (flatpickrInstance) {
        console.log("Destroying existing Flatpickr instance.");
        flatpickrInstance.destroy();
      }

      flatpickrInstance = flatpickr(datetimeInput, {
        enableTime: true,
        noCalendar: false,
        dateFormat: "Y-m-d H:i", // Display format: "YYYY-MM-DD HH:MM"
        time_24hr: true,
        minDate: new Date().fp_incr(1), // Start from tomorrow (adjust if today's slots are allowed)
        minuteIncrement: 30, // Flatpickr generates time slots in 30 minute increments
        locale: (document.documentElement.lang === 'de' ? 'de' : 'en'), // Set locale dynamically

        // --- Flatpickr Logic for Enabling/Disabling Dates and Times ---
        // Step 1: Disable general times outside working hours and weekends. This is a coarse filter.
        disable: [
          function(date) {
            // This 'date' object from Flatpickr is in the client's local timezone.
            const localHour = date.getHours();
            const localMinute = date.getMinutes();
            const dayOfWeek = date.getDay(); // Sunday is 0, Saturday is 6

            // Disable before 9:00 AM and from 5:00 PM onwards (local time for the client)
            // Note: This 'disable' rule is for general appearance. The 'enable' array has final say.
            if (localHour < 9 || localHour >= 17) {
              return true; // Disable if outside 9 AM - 4:59 PM range
            }

            // Disable minutes that are not 00 or 30
            if (localMinute % 30 !== 0) {
              return true; // Disable if not on the hour or half-hour
            }

            // Disable weekends
            if (dayOfWeek === 0 || dayOfWeek === 6) {
              return true; // Disable Sunday or Saturday
            }

            return false; // Otherwise, do not disable based on these general rules
          }
        ],
        // Step 2: Explicitly enable only the parsed available slots received from n8n.
        // 'enable' takes precedence over 'disable'. This is the critical part for exact matches.
        enable: parsedAvailableDates,
        // --- END Flatpickr Logic ---

        // --- Flatpickr Hooks for Debugging and UI ---
        onReady: function(selectedDates, dateStr, instance) {
          console.log("Flatpickr is ready. Selected dates:", selectedDates, "Date string:", dateStr);
          if (parsedAvailableDates.length === 0) {
            showMessage((document.documentElement.lang === 'de' ? 'Leider sind für die nächste Zeit keine Termine verfügbar.' : 'Unfortunately, there are no available slots for the near future.'), 'info');
            datetimeInput.disabled = true;
            submitButton.disabled = true;
          } else {
            showMessage('', '');
            datetimeInput.disabled = false;
            submitButton.disabled = false;
          }
        },
        onOpen: function() {
          console.log("Flatpickr calendar opened.");
        },
        onChange: function(selectedDates, dateStr, instance) {
          console.log("Flatpickr selection changed:", dateStr);
          if (selectedDates.length > 0) {
            const selectedDate = selectedDates[0];
            // Create a clean version of the selected date for comparison, matching the 'enable' array's precision
            const cleanSelectedDate = new Date(
              selectedDate.getFullYear(),
              selectedDate.getMonth(),
              selectedDate.getDate(),
              selectedDate.getHours(),
              selectedDate.getMinutes(),
              0, 0 // Ensure seconds and milliseconds are 0 for consistent comparison
            );

            // Check if the cleaned selected date is present in our list of truly available slots
            const isValidSelection = parsedAvailableDates.some(d => d.getTime() === cleanSelectedDate.getTime());
            if (!isValidSelection) {
              console.warn("User selected a date/time not in available slots. This should ideally not happen if enable/disable works correctly.");
              // Option: Clear the invalid selection automatically
              instance.clear();
              showMessage((document.documentElement.lang === 'de' ? 'Bitte wählen Sie nur verfügbare Zeitfenster.' : 'Please select only available time slots.'), 'error');
            } else {
              console.log("Selected date/time IS in available slots:", dateStr);
              showMessage('', ''); // Clear message if selection is valid
            }
          }
        },
        // Robust onParseConfig to prevent errors
        onParseConfig: function(config) {
          console.log("Flatpickr onParseConfig - FULL config object:", config);

          let enableLog = "undefined/null";
          if (config && typeof config.enable !== 'undefined' && config.enable !== null) {
            if (Array.isArray(config.enable)) {
              enableLog = config.enable.map(d => d.toLocaleString()).slice(0, 5); // Log local string for readability
            } else {
              enableLog = config.enable;
            }
          }
          console.log("Flatpickr onParseConfig - config.enable (first 5 items or value):", enableLog);

          let disableLog = "undefined/null";
          if (config && typeof config.disable !== 'undefined' && config.disable !== null) {
            if (Array.isArray(config.disable) || typeof config.disable === 'function') {
              disableLog = config.disable;
            } else {
              disableLog = config.disable;
            }
          }
          console.log("Flatpickr onParseConfig - config.disable:", disableLog);

          return config;
        },
        // onDayCreate can be noisy, uncomment for very deep debugging only
        /*
        onDayCreate: function(dObj, dStr, fp, dayElem) {
            const slotTime = new Date(dObj.getFullYear(), dObj.getMonth(), dObj.getDate(), dObj.getHours(), dObj.getMinutes(), 0, 0);
            const isDisabledByFlatpickr = dayElem.classList.contains('flatpickr-disabled');
            const isAvailableInOurData = parsedAvailableDates.some(enabledDate => enabledDate.getTime() === slotTime.getTime());

            // Log only for the first few days to limit output
            if (dObj.getDate() === new Date().fp_incr(1).getDate()) { // Only for tomorrow
                console.log(`DayCreate - ${slotTime.toLocaleString()} | isDisabledByFlatpickr: ${isDisabledByFlatpickr} | isAvailableInOurData: ${isAvailableInOurData}`);
            }
        }
        */
      });

    } catch (error) {
      console.error('Error fetching available slots:', error);
      showMessage((document.documentElement.lang === 'de' ? 'Konnte verfügbare Slots nicht laden. Bitte versuchen Sie es später erneut.' : 'Could not load available slots. Please try again later.'), 'error');
      datetimeInput.disabled = true;
      submitButton.disabled = true;
    }
  }

  // --- DOMContentLoaded for initial setup and loading slots ---
  document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM content loaded. Initializing form and loading slots.");
    const appointmentForm = document.getElementById('appointmentForm');
    const datetimeInput = document.getElementById('datetime');
    const submitButton = document.querySelector('#appointmentForm button[type="submit"]');

    // Initial state: disable input and button until slots are loaded
    datetimeInput.disabled = true;
    submitButton.disabled = true;

    appointmentForm.addEventListener('submit', async function(event) {
      event.preventDefault();

      const selectedDateTime = flatpickrInstance.selectedDates[0]; // Get Date object from Flatpickr instance

      if (!selectedDateTime) {
        showMessage((document.documentElement.lang === 'de' ? 'Bitte wählen Sie ein Datum und eine Uhrzeit für Ihren Termin aus.' : "Please select a date and time for your appointment."), "error");
        return;
      }

      // Before sending, ensure the selected time is actually valid based on our parsed slots
      const cleanSelectedDateTimeForValidation = new Date(
        selectedDateTime.getFullYear(),
        selectedDateTime.getMonth(),
        selectedDateTime.getDate(),
        selectedDateTime.getHours(),
        selectedDateTime.getMinutes(),
        0, 0 // Crucial for matching with parsedAvailableDates
      );
      const isValidFinalSelection = parsedAvailableDates.some(d => d.getTime() === cleanSelectedDateTimeForValidation.getTime());

      if (!isValidFinalSelection) {
        showMessage((document.documentElement.lang === 'de' ? 'Выбранное время недоступно. Пожалуйста, выберите доступное время.' : 'The selected time is not available. Please choose an available slot.'), "error");
        console.error("Attempted to submit an unavailable slot!");
        return; // Prevent submission of invalid slot
      }


      const formData = new FormData(this);
      const data = Object.fromEntries(formData.entries());

      data.telegramNotifications = !!data.telegramNotifications;
      // Format for n8n: YYYY-MM-DDTHH:mm:ss (without Z for local time interpretation on n8n side if preferred)
      data.dateTime = selectedDateTime.toISOString().slice(0, 19);

      submitButton.disabled = true; // Disable button during submission
      showMessage((document.documentElement.lang === 'de' ? 'Ihre Buchung wird übermittelt...' : "Submitting your booking..."), "info");

      try {
        const response = await axios.post(N8N_WEBHOOK_URL_BOOK_APPOINTMENT, data);

        const result = response.data[0] || {}; // n8n usually returns an array of objects

        if (response.status >= 200 && response.status < 300) { // Check for 2xx success codes
          showMessage((document.documentElement.lang === 'de' ? 'Vielen Dank! Ihre Buchungsanfrage wurde empfangen. Unser Manager wird Sie zur Bestätigung kontaktieren.' : "Thank you! Your booking request has been received. Our manager will contact you for confirmation."), "success");
          appointmentForm.reset();
          datetimeInput.value = ''; // Clear selected datetime
          await loadAvailableSlots(); // Reload available slots after successful booking
        } else {
          const errorMessage = result.message || (document.documentElement.lang === 'de' ? `Termin konnte nicht erstellt werden. Status: ${response.status}` : `Failed to create appointment. Status: ${response.status}`);
          showMessage(errorMessage, "error");
          console.error("Booking failed response:", response.data);
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        const errorMessage = error.response && error.response.data &&
          (typeof error.response.data === 'string' ? error.response.data : JSON.stringify(error.response.data))
          || (document.documentElement.lang === 'de' ? "Unbekannter Netzwerk- oder Serverfehler." : "Unknown network or server error.");
        showMessage((document.documentElement.lang === 'de' ? `Beim Senden Ihrer Anfrage ist ein Fehler aufgetreten: ${errorMessage}. Bitte versuchen Sie es erneut.` : `An error occurred while submitting your request: ${errorMessage}. Please try again.`), "error");
      } finally {
        submitButton.disabled = false; // Re-enable button
      }
    });

    // Initially load available slots
    loadAvailableSlots();
  });
</script>
</body>
</html>
